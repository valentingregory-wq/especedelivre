<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>AR - Œuvre</title>

  <!-- A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
  <!-- MindAR (A-Frame integration) -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:black; }
    #ar-container { width:100%; height:100vh; position:relative; }
    .overlay-instructions {
      position: absolute;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.5);
      color: #fff;
      padding:8px 12px;
      border-radius:8px;
      font-family: sans-serif;
      font-size:14px;
      z-index: 20;
      text-align: center;
    }
    .topbar {
      position:absolute;
      top:10px;
      left:10px;
      color:white;
      z-index:20;
      font-family: sans-serif;
      background: rgba(0,0,0,0.35);
      padding:6px 8px;
      border-radius:6px;
      font-size:13px;
    }
  </style>
</head>
<body>
  <div id="ar-container">
    <div class="topbar">Pointer la caméra sur l'œuvre</div>
    <div class="overlay-instructions" id="instructions">
      Scannez l’œuvre et déplacez votre téléphone — appuyez pour recadrer
    </div>

    <a-scene
      mindar-image="imageTargetSrc: target.mind; maxTrack: 1; uiLoading: no; uiError: no; uiScanning: no;"
      vr-mode-ui="enabled: false"
      embedded
      renderer="colorManagement: true, physicallyCorrectLights: true"
      arjs="sourceType: webcam;"
    >
      <a-entity camera></a-entity>

      <!-- Anchor : la surimpression sera fixée sur la target -->
      <a-anchor mindar-image-target="0">
        <a-plane
          id="overlay-plane"
          position="0 0 0"
          rotation="0 0 0"
          width="1.5"
          height="2"
          material="shader: flat; src: #calqueTex; transparent: true;"
        ></a-plane>
      </a-anchor>

      <a-assets>
        <img id="calqueTex" src="calque.png" />
      </a-assets>
    </a-scene>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const scene = document.querySelector('a-scene');
      const instructions = document.getElementById('instructions');

      // Fonction pour démarrer MindAR
      const startMindAR = async () => {
        try {
          await scene.components['mindar-image'].start();
          instructions.style.display = "none";
          console.log("MindAR démarré !");
        } catch (err) {
          console.error("Erreur MindAR : ", err);
          instructions.innerText = "Impossible d'accéder à la caméra.\nAssurez-vous d'utiliser HTTPS et d'autoriser la caméra.";
        }
      };

      // Déclencher au premier tap (exigence iOS/Android)
      const startOnTouch = () => {
        document.body.addEventListener('click', startMindAR, { once: true });
      };

      startOnTouch();
    });
  </script>
</body>
</html>
